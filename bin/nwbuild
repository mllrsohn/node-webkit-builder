#!/usr/bin/env node
var optimist = require('optimist');
var updateNotifier = require('update-notifier');
var NwBuilder = require('./../lib');
var path = require('path');
var detectCurrentPlatform = require('../lib/detectCurrentPlatform.js');

var argv = optimist
    .usage('Usage: nwbuild [options] [path]')

    .alias('p', 'platforms')
    .default('p', 'osx,win')
    .describe('p', 'Platforms to build, comma-sperated, can be: win,osx,linux32,linux64')

    .alias('v', 'version')
    .default('v', 'latest')
    .describe('v', 'The nw version, eg. 0.8.4')

    .alias('r', 'run')
    .default('r', false)
    .describe('r', 'Runs node-webkit for the current platform')
    .boolean('r')


    .alias('o', 'buildDir')
    .default('o', './build')
    .describe('o', 'The build folder')


    .alias('f', 'forceDownload')
    .default('f', false)
    .describe('f', 'Force download of node-webkit')
    .boolean('f')




    .describe('appName', 'The Name of your node-webkit app')
    .default('appName', false)
    
    .describe('appVersion', 'The version of your node-webkit app')
    .default('appVersion', false)
    
    .describe('cacheDir', 'The directory to store cached node-webkit downloads')
    .default('cacheDir', false)
    
    .describe('buildNamingScheme', 'How you want to name your builds, one of "default", "versioned", "timestamped"')
    .default('buildNamingScheme', 'default')
    
    .describe('macCredits', 'MAC ONLY: The path to your credits.html file')
    .default('macCredits', false)
    
    .describe('macIcns', 'MAC ONLY: The path to your ICNS icon file')
    .default('macIcns', false)
    
    .describe('macZip', 'MAC ONLY: Use a app.nw folder instead of ZIP file')
    .default('macZip', false)
    .boolean('macZip')
    
    .describe('macPlist', 'MAC ONLY: if you supply a string to a Plist file it will use it')
    .default('macPlist', false)
    
    .describe('winIco', 'WINDOWS ONLY: The path to your ICO icon file (requires Windows/Wine)')
    .default('winIco', null)




    .default('quiet', false)
    .describe('quiet', 'Disables logging')
    .boolean('quiet')

    .argv;

// Howto Help
if (argv.h || argv.help) {
    optimist.showHelp();
    process.exit(0);
}

// Update notification
var notifier = updateNotifier({
    packagePath: './../package.json'
});
if (notifier.update) {
    notifier.notify();
}

// Error if there are no files
var files = argv._[0];
if(!files) {
    optimist.showHelp();
    process.exit(0);
}

var options = {
    files: path.resolve(process.cwd(), files) + '/**/*',
    platforms: argv.platforms.split(','),
    version: argv.version,
    cacheDir: path.resolve(__dirname, '..', 'cache'),
    buildDir: path.resolve(process.cwd(), argv.buildDir),
    forceDownload: argv.forceDownload
};

// Additional CLI options that correspond directly to API options
for(var k in argv){
    if(!options[k]){
        options[k] = argv[k];
    }
}

// Check Platform, if we are in run mode
if(argv.r) {
    var currentPlatform = detectCurrentPlatform();
    options.platforms = [ currentPlatform ];
    options.currentPlatform = currentPlatform;
}

// Build App
var nw = new NwBuilder(options);

// Logging
if(!(argv.quiet || argv.quite)) {
    nw.on('log',  console.log);
}

// Build or run the app
var np = (argv.r ? nw.run() : nw.build());
np.then(function() {
    process.exit(0);
}).catch (function(error) {
    if (error) console.error(error);
    process.exit(0);
});
